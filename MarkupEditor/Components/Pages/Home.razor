@page "/"
@inject IJSRuntime JS
@inject AppState AppState
@using CommunityToolkit.Maui.Storage
@using System.Text

<div class="editor-page-wrapper">
    @* --- TOOLBAR MIT SNIPPETS & EMOJIS --- *@
    <div class="toolbar">
        <div class="snippet-bar">
            <div class="group">
                <button class="tool-btn" @onclick='() => AddSnippet("# ")'>H1</button>
                <button class="tool-btn" @onclick='() => AddSnippet("## ")'>H2</button>
                <button class="tool-btn" @onclick='() => AddSnippet("### ")'>H3</button>
                <button class="tool-btn" @onclick='() => AddSnippet("**Fett**")'><i class="bi bi-type-bold"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("*Kursiv*")'><i class="bi bi-type-italic"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("~~Durchgestrichen~~")'><i class="bi bi-type-strikethrough"></i></button>
            </div>

            <div class="group">
                <button class="tool-btn" @onclick='() => AddSnippet("- Punkt")'><i class="bi bi-list-ul"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("1. Punkt")'><i class="bi bi-list-ol"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("- [ ] Aufgabe")'><i class="bi bi-check2-square"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("| Spalte | Spalte |\n|---|---|\n| Text | Text |")'><i class="bi bi-table"></i></button>
            </div>

            <div class="group">
                <button class="tool-btn" @onclick='() => AddSnippet("> Zitat")'><i class="bi bi-quote"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("```csharp\n// Code hier\n```")'><i class="bi bi-code-slash"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("---")'><i class="bi bi-hr"></i></button>
                <button class="tool-btn" @onclick='() => AddSnippet("![Bildbeschreibung](preview.png)")' title="Bild einf√ºgen">
                    <i class="bi bi-image"></i>
                </button>
                <button class="tool-btn" @onclick='() => AddSnippet("[Link Text](https://google.com)")'><i class="bi bi-link-45deg"></i></button>
            </div>

            <div class="group position-relative">
                <button type="button" class="tool-btn" @onclick="ToggleEmojiPicker" title="Emoji ausw√§hlen">
                    <i class="bi bi-emoji-smile"></i> v
                </button>

                @if (showEmojiPicker)
                {
                    <div class="emoji-popover">
                        @foreach (var group in emojiGroups)
                        {
                            <div class="emoji-group-title">@group.Key</div>
                            <div class="emoji-grid">
                                @foreach (var emoji in group.Value)
                                {
                                    <button type="button" class="emoji-item" @onclick="() => SelectEmoji(emoji)">
                                        @emoji
                                    </button>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-open" @onclick="OpenFileNative">
                <i class="bi bi-folder2-open me-1"></i> √ñffnen
            </button>
            <button class="btn-save" @onclick="SaveFileNative">
                <i class="bi bi-file-earmark-arrow-down me-1"></i> Speichern
            </button>
        </div>
    </div>

    @* --- EDITOR & VORSCHAU --- *@
    <div class="split-screen">
        <textarea @ref="editorRef"
                  class="editor-pane"
                  @bind="MarkdownValue"
                  @bind:event="oninput"
                  spellcheck="false"
                  placeholder="Schreibe dein Markdown...">
        </textarea>

        <div class="preview-pane">
            <div class="markdown-body">
                @((MarkupString)htmlPreview)
            </div>
        </div>
    </div>
</div>

@code {
    private ElementReference editorRef;
    private string htmlPreview = "";
    private bool showEmojiPicker = false;

    private string MarkdownValue
    {
        get => AppState.MarkdownText;
        set
        {
            if (AppState.MarkdownText != value)
            {
                AppState.MarkdownText = value;
                _ = ConvertMarkdown();
            }
        }
    }

    private Dictionary<string, string[]> emojiGroups = new()
    {
        { "Status", new[] { "üöÄ", "‚úÖ", "‚ùå", "‚ö†Ô∏è", "üöß", "üõë", "üÜï", "üÜô", "‚ú®", "üî•" } },
        { "Tech", new[] { "üíª", "‚öôÔ∏è", "üõ†Ô∏è", "üì¶", "üíæ", "üîå", "üîí", "üîë", "üõ°Ô∏è", "üß™" } },
        { "Info", new[] { "üí°", "‚ÑπÔ∏è", "üìù", "üìå", "üîç", "üìñ", "üé®", "üåê" } },
        { "Feedback", new[] { "‚≠ê", "üíé", "üëç", "üôå", "üéâ", "üëè", "üéà", "üßß" } }
    };

    private void ToggleEmojiPicker() => showEmojiPicker = !showEmojiPicker;

    private async Task SelectEmoji(string emoji)
    {
        await AddSnippet(emoji + " ");
        showEmojiPicker = false;
    }

    private async Task AddSnippet(string snippet)
    {
        try
        {
            AppState.MarkdownText = await JS.InvokeAsync<string>("editorFunctions.insertText", editorRef, snippet);
            await ConvertMarkdown();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler beim Einf√ºgen: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ConvertMarkdown();
        }
    }

    private async Task ConvertMarkdown()
    {
        try
        {
            htmlPreview = await JS.InvokeAsync<string>("marked.parse", AppState.MarkdownText);
            StateHasChanged();
            await JS.InvokeVoidAsync("editorFunctions.renderHighlight");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Render-Fehler: {ex.Message}");
        }
    }

    private async Task OpenFileNative()
    {
        try
        {
            var result = await FilePicker.Default.PickAsync(new PickOptions
            {
                PickerTitle = "Markdown Datei √∂ffnen",
                FileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
                {
                    { DevicePlatform.WinUI, new[] { ".md", ".txt" } },
                    { DevicePlatform.macOS, new[] { "md", "txt" } },
                    { DevicePlatform.Android, new[] { "text/markdown", "text/plain" } },
                    { DevicePlatform.iOS, new[] { "public.text" } }
                })
            });

            if (result != null)
            {
                using var stream = await result.OpenReadAsync();
                using var reader = new StreamReader(stream);
                MarkdownValue = await reader.ReadToEndAsync();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Fehler beim √ñffnen: {ex.Message}");
        }
    }

    private async Task SaveFileNative()
    {
        try
        {
            using var stream = new MemoryStream(Encoding.UTF8.GetBytes(AppState.MarkdownText));
            var fileSaveResult = await FileSaver.Default.SaveAsync("README.md", stream, default);

            if (fileSaveResult.IsSuccessful)
            {
                await JS.InvokeVoidAsync("alert", $"Gespeichert unter: {fileSaveResult.FilePath}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Fehler beim Speichern: {ex.Message}");
        }
    }
}

<style>
    .editor-page-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background: #0d1117;
        color: white;
        overflow: hidden;
    }

    .toolbar {
        padding: 8px 15px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .snippet-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .group {
        display: flex;
        gap: 2px;
        background: #21262d;
        border-radius: 6px;
        padding: 3px;
        border: 1px solid #30363d;
        align-items: center;
    }

    .tool-btn {
        background: transparent;
        border: none;
        color: #c9d1d9;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
    }

        .tool-btn:hover {
            background: #30363d;
            color: white;
        }

    .action-buttons {
        display: flex;
        gap: 10px;
    }

    /* --- Buttons Styling --- */
    .btn-save, .btn-open {
        background: linear-gradient(135deg, #30363d 0%, #21262d 100%) !important;
        color: #ffffff !important;
        border: 1px solid #484f58 !important;
        padding: 6px 16px !important;
        border-radius: 20px !important;
        font-size: 0.85rem !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

        .btn-save:hover {
            background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%) !important;
            border-color: #3fb950 !important;
            box-shadow: 0 0 12px rgba(63, 185, 80, 0.4) !important;
        }

        .btn-open:hover {
            background: linear-gradient(135deg, #1f6feb 0%, #0d419d 100%) !important;
            border-color: #58a6ff !important;
            box-shadow: 0 0 12px rgba(88, 166, 255, 0.4) !important;
        }

    .split-screen {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .editor-pane {
        flex: 1;
        padding: 25px;
        background: #0d1117;
        color: #e6edf3;
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        border: none;
        border-right: 1px solid #30363d;
        outline: none;
        resize: none;
        font-size: 14px;
        line-height: 1.6;
    }

    .preview-pane {
        flex: 1;
        padding: 40px;
        background: #ffffff;
        color: black;
        overflow-y: auto;
    }

    .emoji-popover {
        position: absolute;
        top: 110%;
        left: 0;
        width: 280px;
        max-height: 350px;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        z-index: 1050;
        padding: 12px;
        overflow-y: auto;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 5px;
    }

    .emoji-item {
        background: transparent;
        border: none;
        font-size: 18px;
        padding: 6px;
        cursor: pointer;
    }

    .markdown-body pre {
        background-color: #161b22 !important;
        padding: 16px;
        border-radius: 6px;
    }

    @@media (max-width: 768px) {
        .split-screen {
            flex-direction: column;
        }

        .editor-pane {
            height: 50%;
            border-right: none;
            border-bottom: 1px solid #30363d;
        }
    }
</style>